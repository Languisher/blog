---
title: "进程"
description: "本文是 CS:APP 8.2 节的笔记。）"
date: 2024-08-14
category: ["Computer System"]
tags: ["CS:APP"]
---


> 本文是 CS:APP 8.2 节的笔记。

## 基本概念

**进程 (Process)** 是计算机系统中的核心概念。在现代系统上会同时运行很多程序，进程的定义就是一个执行中程序的*实例 (Instance)*. 通过进程，我们能够实现一个假象，即我们的程序是系统中当前运行唯一的程序，因此独占处理器和内存。

为了分别达到“独占”的目的，因此需要对应的关键抽象：
- 逻辑控制流假使我们的程序独占处理器
- 私有地址空间假使我们的程序独占内存系统

### 并发流和并行流

对应第一个抽象：进程独占处理器。

事实上，*系统中的所有进程是轮流使用处理器的。* 如下图所示，每一列都是对应进程的**逻辑控制流 (Logical Control Flow)** 且每一个竖直的条都代表是逻辑控制流的一部分。

![](https://pub-f4fb14aad5ef4ee6a83bd71292941254.r2.dev/202408141228940.png)

每一个进程，换言之其逻辑控制流的运行都是交错的：先运行一会儿 A，再运行 B，接着运行 C.... 每个进程在运行其流的一部分之后，被别的进程所**抢占 (Preempted)**，其自身也被称作暂时挂起的状态。

对于不同（进程的）逻辑控制流而言，若其执行时间相互*重叠*（这里的重叠意味着，假设 X 在 Y 前先开始执行，则 X 至少应该在 Y 开始执行之后结束），则称之为**并发流 (Concurrent Flow)**. 这些并发流的执行称之为**并发 (Concurrency)**. **多任务 (Multi-tasking)** 一词很好地描述了并发的思想。更多术语：一个进程执行其控制流的每一时间段（即上图的时间条）称之为**时间片 (Time Slice)**，因此多任务也被称之为**时间分片 (Time Slicing)**。

注意*多任务*术语与生活中的用词意思有所不同：并不是说在相同时间内有不同的任务在同时进行，比如我在学习的同时打游戏（并行的概念），而是说*一个进程和另一个进程交替运行*。（我学习一会儿、打会儿游戏，重复这个过程）

用计算机术语来说，并发和并行之间的联系是：*如果并发流运行在不同的处理核或计算机中*（这意味着它们可以同时运行），那么这些流可以称之为**并行流 (Parallel Flow)**，称之为**并行运行 (Parallel Execution)**. 很容易看出并行流一定是并发的，并行流是并发流的真子集。


### 私有地址空间

对应第二个抽象：进程独占系统地址空间。

进程为每个程序分配对应的**私有地址空间**，私有意味着其空间不能被其他进程读或写。

### 用户模式和内核模式

有了进程之后，我们需要一个机制能够限制进程对应执行的指令以及其对应的私有地址空间范围。因此，通过一个模式位的设置将进程分成两种模式：**用户模式** 和 **内核模式**。在内核模式中，进程可以访问一切指令和人和内存位置；相反在用户模式中进程没有特权，只能访问自己的部分。

用户模式和内核模式的唯一切换方式是通过**异常**实现的。

### 上下文和上下文切换

系统的每个程序都是有状态的。因此，进程的**上下文 (Context)** 就是为了管理程序正常运行所需要的状态组成，由栈、通用目的寄存器内容、程序计数器、环境变量以及打开文件描述符的集合组成。

为了决定什么时候抢占进程，内核需要做出决策，对应的决策器称之为**调度器 (Scheduler)**. 内核**调度**进程，指内核控制从原先进程转移到新的进程，对应的机制称之为**上下文切换 (Context Switch)**：
1. 保存原先进程上下文
2. 恢复新（或是先前被抢占）进程的上下文
3. 将控制传递给新进程

综上以上两小节，进程切换可以被总结为如下图：

![](https://pub-f4fb14aad5ef4ee6a83bd71292941254.r2.dev/202408141301953.png)